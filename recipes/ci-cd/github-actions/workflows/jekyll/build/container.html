<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">



    <meta property="og:site_name" content="Code Cookbook" />

    <title>Jekyll in a container | Code Cookbook</title>

    <meta property="og:title" content="Jekyll in a container" />

    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Jekyll in a container" />
<meta name="generator" content="Jekyll v4.3.1" />

<meta property="og:locale" content="en_US" />


    <meta name="description" content="Reusable code patterns which you can use as reference or copy to your project" />
    <meta property="og:description" content="Reusable code patterns which you can use as reference or copy to your project" />
<meta name="author" content="Michael Currin" />



<link rel="canonical" href="https://michaelcurrin.github.io/code-cookbook/recipes/ci-cd/github-actions/workflows/jekyll/build/container.html" />
<meta property="og:url" content="https://michaelcurrin.github.io/code-cookbook/recipes/ci-cd/github-actions/workflows/jekyll/build/container.html" />


<script type="application/ld+json">
{
    "name":        "Code Cookbook",
    "description": "Reusable code patterns which you can use as reference or copy to your project",
    "url":         "https://michaelcurrin.github.io/code-cookbook/recipes/ci-cd/github-actions/workflows/jekyll/build/container.html",
    "headline":    "Jekyll in a container",
    "@type":       "WebSite",
    "@context":    "https://schema.org",
    "author": {
        "@type":"Person",
        "name": "Michael Currin"
    }
}
</script>
<link rel="stylesheet" href="/code-cookbook/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://michaelcurrin.github.io/code-cookbook/feed.xml" title="Code Cookbook" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-ED9PSVN5DS"></script>
    <script>
        window['ga-disable-G-ED9PSVN5DS'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
        window.dataLayer = window.dataLayer || [];

        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-ED9PSVN5DS');
    </script></head>
<body>
<header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/code-cookbook/">
            Code Cookbook
        </a><nav class="site-nav">
                <input type="checkbox" id="nav-trigger" class="nav-trigger" />

                <label for="nav-trigger">
                    <span class="menu-icon">
                        <svg viewBox="0 0 18 15" width="18px" height="15px">
                            <path
                                d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
                        </svg>
                    </span>
                </label>

                <div class="trigger"><a class="page-link" href="/code-cookbook/">
                                Home
                            </a><a class="page-link" href="/code-cookbook/recipes/">
                                Recipes
                            </a><a class="page-link" href="/code-cookbook/about.html">
                                About
                            </a></div>
            </nav></div>
</header>
<main class="page-content" aria-label="Content">
        <div class="wrapper">
            <a id="github-edit" href="https://github.com/MichaelCurrin/code-cookbook/edit/master/recipes/ci-cd/github-actions/workflows/jekyll/build/container.md">
    üìù <span>Edit page</span>
</a>

            <a id="github-add" href="https://github.com/MichaelCurrin/code-cookbook/new/master/recipes/ci-cd/github-actions/workflows/jekyll/build/">
    ‚ûï <span>Add page</span>
</a>


            

<article class="post">
    <header class="post-header">
        <h1 class="post-title">
            


            <span>Jekyll in a container</span>
        </h1>

        
    </header>

    


    <div id="breadcrumbs">

    
        

        
            
            <a href="/code-cookbook/recipes/">
    Recipes
</a>

        
     
        
            /
        

        
            
            <a href="/code-cookbook/recipes/ci-cd/">
    CI/CD
</a>

        
     
        
            /
        

        
            
            <a href="/code-cookbook/recipes/ci-cd/github-actions/">
    GitHub Actions
</a>

        
     
        
            /
        

        
            
            <a href="/code-cookbook/recipes/ci-cd/github-actions/workflows/">
    Workflows
</a>

        
     
        
            /
        

        
            
            <a href="/code-cookbook/recipes/ci-cd/github-actions/workflows/jekyll/">
    Jekyll
</a>

        
     
        
            /
        

        
            
            <a href="/code-cookbook/recipes/ci-cd/github-actions/workflows/jekyll/build/">
    Build and deploy
</a>

        
     
        
            /
        

        
            <a href="/code-cookbook/recipes/ci-cd/github-actions/workflows/jekyll/build/container.html" class="underline">
                Jekyll in a container
            </a>
        
     
    </div>



    <br>

    <div class="post-content">
        
            <p>Related recipe - <a href="/code-cookbook/recipes/containers/docker/jekyll.html">Jekyll</a> in the Container section.</p>

<p>This flow runs a <strong>Docker container</strong>. If you don‚Äôt want to use Docker, see <a href="/code-cookbook/recipes/ci-cd/github-actions/workflows/jekyll/build/generic.html">Jekyll Ruby Action</a>, which is a light approach.</p>

<p>It runs Jekyll inside a container that is run as a binary (using <code class="language-plaintext highlighter-rouge">docker</code> CLI but no <code class="language-plaintext highlighter-rouge">Dockerfile</code> needed). So it can be used as a drop-in replacement for running <code class="language-plaintext highlighter-rouge">jekyll</code> directly.</p>

<p>Plus, the container takes care of Ruby and Jekyll dependencies and installing project gems. This <code class="language-plaintext highlighter-rouge">builder</code> image even includes <strong>Node.js</strong>.</p>

<p>Based on <a href="https://github.com/actions/starter-workflows/blob/main/ci/jekyll.yml">jekyll.yml</a> - a starter workflow provided by GitHub.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">main.yml</code>
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">name</span><span class="pi">:</span> <span class="s">GH Pages deploy</span>

  <span class="na">on</span><span class="pi">:</span>
    <span class="na">push</span><span class="pi">:</span>
      <span class="na">branches</span><span class="pi">:</span> <span class="s">main</span>
      <span class="na">paths-ignore</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">README.md</span>

    <span class="na">pull_request</span><span class="pi">:</span>
      <span class="na">branches</span><span class="pi">:</span> <span class="s">main</span>
      <span class="na">paths-ignore</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">README.md</span>

  <span class="na">jobs</span><span class="pi">:</span>
    <span class="na">build-deploy</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Build and deploy</span>

      <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>

      <span class="na">steps</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout üõéÔ∏è</span>
          <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>

        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build Jekyll site</span>
          <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">docker run \</span>
              <span class="s">-v ${{ github.workspace }}:/srv/jekyll \</span>
              <span class="s">jekyll/builder:4.2.0 \</span>
              <span class="s">/bin/bash -c 'chmod 777 /srv/jekyll &amp;&amp; bundle exec jekyll build --future'</span>

        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy to GH Pages üöÄ</span>
          <span class="na">if</span><span class="pi">:</span> <span class="s">${{ github.event_name != 'pull_request' }}</span>
          <span class="na">uses</span><span class="pi">:</span> <span class="s">peaceiris/actions-gh-pages@v3</span>
          <span class="na">with</span><span class="pi">:</span>
            <span class="na">github_token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
            <span class="na">publish_dir</span><span class="pi">:</span> <span class="s">_site</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>You can use <code class="language-plaintext highlighter-rouge">jekyll COMMAND</code> or <code class="language-plaintext highlighter-rouge">bundle exec jekyll COMMAND</code>. The latter is probably safer, using the project Jekyll instead of the global Jekyll (at least global inside the container).</p>

<p>Make sure that the image tag Jekyll version matches the Jekyll version in <code class="language-plaintext highlighter-rouge">Gemfile</code>. Though, you could even leave Jekyll out of <code class="language-plaintext highlighter-rouge">Gemfile</code>, but I wouldn‚Äôt recommend it, so you can still run it outside a container.</p>

<p>See <a href="https://hub.docker.com/r/jekyll/builder/tags?page=1&amp;ordering=last_updated">jekyll/builder tags</a> available.</p>

<p>If you want to use say Jekyll <code class="language-plaintext highlighter-rouge">4.3</code> in your Gemfile and the Docker image tag is not available, you could use <code class="language-plaintext highlighter-rouge">bundle exec jekyll build</code> as the command passed to the container. To ensure the project Jekyll gets used, instead of the container‚Äôs global Jekyll.</p>

<h2 id="about-the-approach">About the approach</h2>

<p>This builds the site using a <strong>Docker</strong> container step. This means you don‚Äôt need to use any Action from the marketplace to set up your Ruby and Jekyll environment. The container image is ready to go. When you run it, it will even install your gems for you using Bundler.</p>

<p>I think this is great - I don‚Äôt know why there are so many Jekyll actions out there. Maybe if you really need control over the environment or build steps. Some actions include Jekyll and GH Pages in one - I don‚Äôt think it is a good idea to mix those together in one inseparable step.</p>

<p>Another advantage is that you can run the exact same container locally - which is great for debugging and for running your application locally on any OS without requiring Ruby, Bundler and gems installed.</p>

<p>An advantage of using Docker here is that you can run the same command locally - no Ruby or Jekyll needed. You can move the full docker command to a <code class="language-plaintext highlighter-rouge">Makefile</code> too to make it easier to run as <code class="language-plaintext highlighter-rouge">make build</code>.</p>

<h3 id="caching-note">Caching note</h3>

<p>A disadvantage of using Docker here is that the image is not cached and so must be downloaded each time. I found an action which supports caching of Docker images, but adds extra steps and complexity. Maybe the plain cache action can work for Docker cache directory?</p>

<p>Also, the gems have to be downloaded and installed each time, which be avoided by adding the cache action, even if it doesn‚Äôt cache the image.</p>

<h2 id="notes-on-the-workflow">Notes on the workflow</h2>

<ul>
  <li>Using the Docker step alone output would get thrown away after the build. If you want to persist as a GH Pages site, just add on the last section as below, using a generic GH Pages action.</li>
  <li>You can pick a tag like <code class="language-plaintext highlighter-rouge">4</code> to get a recent version in <code class="language-plaintext highlighter-rouge">4.x</code> range. I‚Äôd avoid <code class="language-plaintext highlighter-rouge">latest</code> as one day you‚Äôll suddenly get <code class="language-plaintext highlighter-rouge">5</code>. GH Pages normally limits you to <code class="language-plaintext highlighter-rouge">3.9</code>.</li>
  <li>The <code class="language-plaintext highlighter-rouge">--future</code> flag is to publish future-dated posts.</li>
</ul>

<h2 id="original-workflow">Original workflow</h2>

<p>The workflow is based on the one generated by the GitHub when it suggests a Jekyll workflow for your project.</p>

<h3 id="my-changes">My changes</h3>

<ul>
  <li>Use Jekyll version <code class="language-plaintext highlighter-rouge">4</code> instead of <code class="language-plaintext highlighter-rouge">latest</code>, to avoid upgrading to 5 by accident. Also, you can use <code class="language-plaintext highlighter-rouge">4.2</code> etc. if such as tag exists.</li>
  <li>Add GH Pages at the end to persist on <code class="language-plaintext highlighter-rouge">gh-pages</code> branch. I‚Äôve also set up this deploy step only runs on the main branch, not feature branches.</li>
  <li>Remove a volume.</li>
</ul>

<p>I tried to use <code class="language-plaintext highlighter-rouge">$PWD</code> instead of <code class="language-plaintext highlighter-rouge">${{ github.workspace }}</code> I but got a permissions error. Just make sure to use <code class="language-plaintext highlighter-rouge">$PWD</code> for local use. i.e. <code class="language-plaintext highlighter-rouge">-v "$PWD:/srv/jekyll"</code></p>

<p>See related notes below.</p>

<h3 id="permissions-note">Permissions note</h3>

<p>Note use of <code class="language-plaintext highlighter-rouge">chmod 777</code> for the directory (not for the files in it).</p>

<p>If this is <em>not</em> included, then the container logs that it is installing gems which fails because of no permissions to write to <code class="language-plaintext highlighter-rouge">Gemfile.lock</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>There was an error while trying to write to `/srv/jekyll/Gemfile.lock`. It is
</code></pre></div></div>

<p>I don‚Äôt know how this works though. The entry-point command given to the container is only meant to run after the docker has set up gems internally.</p>

<h3 id="volume-note">Volume note</h3>

<p>Note that GitHub‚Äôs own starter workflow mounts <strong>two</strong> volumes, when only one is needed.</p>

<p>Here it is anyway with <code class="language-plaintext highlighter-rouge">_site</code> as a volume.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-v ${{ github.workspace }}:/srv/jekyll \
-v ${{ github.workspace }}/_site:/srv/jekyll/_site \
</code></pre></div></div>

<p>The second is unnecessary as it is already covered by the first as a nested directory with the identical name in and outside the container.</p>


        
    </div>
</article>

        </div>
    </main>
<footer class="site-footer h-card">
    <data class="u-url" href="/code-cookbook/"></data>

    <div class="wrapper">

        <h2 class="footer-heading">Code Cookbook</h2>

        <div class="footer-col-wrapper">
            <div class="footer-col footer-col-1">
                <ul class="contact-list"><li class="p-name">
                            Michael Currin
                        </li></ul>
            </div>

            <div class="footer-col footer-col-2">
<ul class="social-media-list"><li>
            <a href="https://github.com/MichaelCurrin"><svg class="svg-icon">
                    <use xlink:href="/code-cookbook/assets/fractal-social-icons.svg#github"></use>
                </svg> <span class="username">MichaelCurrin</span></a>
        </li></ul>
</div>

            <div class="footer-col footer-col-3">
                <p>Reusable code patterns which you can use as reference or copy to your project</p>
            </div>
        </div>

    </div>

</footer>
<a href="https://github.com/MichaelCurrin/code-cookbook"
    class="github-corner" aria-label="View source on GitHub">
    <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
    </svg>
</a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

</body>

</html>
