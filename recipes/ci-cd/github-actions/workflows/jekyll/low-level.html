<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">



    <meta property="og:site_name" content="Code Cookbook" />

    <title>Low-level | Code Cookbook</title>

    <meta property="og:title" content="Low-level" />

    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Low-level" />
<meta name="generator" content="Jekyll v4.4.1" />

<meta property="og:locale" content="en_US" />


    <meta name="description" content="Run Jekyll against the docs directory and publish to GH Pages, using generic actions" />
    <meta property="og:description" content="Run Jekyll against the docs directory and publish to GH Pages, using generic actions" />
<meta name="author" content="Michael Currin" />



<link rel="canonical" href="https://michaelcurrin.github.io/code-cookbook/recipes/ci-cd/github-actions/workflows/jekyll/low-level.html" />
<meta property="og:url" content="https://michaelcurrin.github.io/code-cookbook/recipes/ci-cd/github-actions/workflows/jekyll/low-level.html" />


<script type="application/ld+json">
{
    "name":        "Code Cookbook",
    "description": "Run Jekyll against the docs directory and publish to GH Pages, using generic actions",
    "url":         "https://michaelcurrin.github.io/code-cookbook/recipes/ci-cd/github-actions/workflows/jekyll/low-level.html",
    "headline":    "Low-level",
    "@type":       "WebSite",
    "@context":    "https://schema.org",
    "author": {
        "@type":"Person",
        "name": "Michael Currin"
    }
}
</script>
<link rel="stylesheet" href="/code-cookbook/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://michaelcurrin.github.io/code-cookbook/feed.xml" title="Code Cookbook" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-ED9PSVN5DS"></script>
    <script>
        window['ga-disable-G-ED9PSVN5DS'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
        window.dataLayer = window.dataLayer || [];

        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-ED9PSVN5DS');
    </script></head>
<body>
<header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/code-cookbook/">
            Code Cookbook
        </a><nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger" />

            <label for="nav-trigger">
                <span class="menu-icon">
                    <svg viewBox="0 0 18 15" width="18px" height="15px">
                        <path
                            d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
                    </svg>
                </span>
            </label>

            <div class="trigger"><a class="page-link" href="/code-cookbook/">
                    Home
                </a><a class="page-link" href="/code-cookbook/recipes/">
                    Recipes
                </a><a class="page-link" href="/code-cookbook/about.html">
                    About
                </a><a class="ext-link page-link" href="https://michaelcurrin.github.io/dev-cheatsheets/">
                    <span>Dev Cheatsheets</span>
                    <img src="/code-cookbook/assets/ext-link.svg" />
                </a><a class="ext-link page-link" href="https://michaelcurrin.github.io/dev-resources/">
                    <span>Dev Resources</span>
                    <img src="/code-cookbook/assets/ext-link.svg" />
                </a></div>
        </nav></div>
</header>
<main class="page-content" aria-label="Content">
        <div class="wrapper">
            <a id="github-edit" href="https://github.com/MichaelCurrin/code-cookbook/edit/master/recipes/ci-cd/github-actions/workflows/jekyll/low-level.md">
    üìù <span>Edit page</span>
</a>

            <a id="github-add" href="https://github.com/MichaelCurrin/code-cookbook/new/master/recipes/ci-cd/github-actions/workflows/jekyll/">
    ‚ûï <span>Add page</span>
</a>


            

<article class="post">
    <header class="post-header">
        <h1 class="post-title">
            


            <span>Low-level</span>
        </h1>

        
            <blockquote>
                <p>Run Jekyll against the docs directory and publish to GH Pages, using generic actions</p>

            </blockquote>
        
    </header>

    


    <div id="breadcrumbs">

    
        

        
            
            <a href="/code-cookbook/recipes/">
    Recipes
</a>

        
     
        
            /
        

        
            
            <a href="/code-cookbook/recipes/ci-cd/">
    CI/CD
</a>

        
     
        
            /
        

        
            
            <a href="/code-cookbook/recipes/ci-cd/github-actions/">
    GitHub Actions
</a>

        
     
        
            /
        

        
            
            <a href="/code-cookbook/recipes/ci-cd/github-actions/workflows/">
    Workflows
</a>

        
     
        
            /
        

        
            
            <a href="/code-cookbook/recipes/ci-cd/github-actions/workflows/jekyll/">
    Jekyll
</a>

        
     
        
            /
        

        
            <a href="/code-cookbook/recipes/ci-cd/github-actions/workflows/jekyll/low-level.html" class="underline">
                Low-level
            </a>
        
     
    </div>



    <br>

    <div class="post-content">
        
            
<h2 id="own">Own</h2>

<p>Dependencies steps:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gem update <span class="nt">--system</span> <span class="nt">--no-document</span>
gem update bundler <span class="nt">--no-document</span>
bundle config <span class="nb">set </span>path vendor/bundle
bundle <span class="nb">install</span> <span class="nt">--jobs</span> 4 <span class="nt">--retry</span> 3 <span class="nt">--frozen</span>
bundle clean
</code></pre></div></div>

<p>Avoid updating the <code class="language-plaintext highlighter-rouge">Gemfile.lock</code> file with <code class="language-plaintext highlighter-rouge">--frozen</code> flag.</p>

<p>The <a href="https://bundler.io/man/bundle-clean.1.html">clean</a> command removes unused gems. I don‚Äôt see it in <code class="language-plaintext highlighter-rouge">bundle -h</code> output though.</p>

<p>Use PeaceIris action to handle the commit part, instead of the detailed committing in the next example.</p>

<p>Consider for Jekyll 4 cache, also caching <code class="language-plaintext highlighter-rouge">.jekyll-cache/</code> for faster builds. Or let the remote build be slower and let the cached build locally be fast.</p>

<h2 id="jekyll-docs">Jekyll docs</h2>

<p>This example is based on a <a href="https://github.com/jekyll/jekyll/pull/8201/files">PR</a> for building Jekyll‚Äôs own docs site at <a href="https://jekyllrb.com">jekyllrb.com</a>, using GH Actions instead of plain GH Pages flow. The code is very low-level for more control but this makes it so not reusable. There are further notes at the end of this page on this. You may want to take pieces of this recipe rather than the whole thing.</p>

<p>I don‚Äôt know why cache keys is too items. I usually see it as one or two lines in a single string.</p>

<p>Note use of <code class="language-plaintext highlighter-rouge">GITHUB_TOKEN</code> near the end.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">docs.yaml</code>
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">name</span><span class="pi">:</span> <span class="s">Build and deploy Jekyll documentation site</span>

  <span class="na">on</span><span class="pi">:</span>
    <span class="na">pull_request</span><span class="pi">:</span>
      <span class="na">branches</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">master</span>

  <span class="na">env</span><span class="pi">:</span>
    <span class="na">RUBY_VERSION</span><span class="pi">:</span> <span class="m">2.7</span>

  <span class="na">jobs</span><span class="pi">:</span>
    <span class="na">deploy_docs</span><span class="pi">:</span>
      <span class="na">if</span><span class="pi">:</span> <span class="s2">"</span><span class="s">!contains(github.event.commits[0].message,</span><span class="nv"> </span><span class="s">'[ci</span><span class="nv"> </span><span class="s">skip]')"</span>

      <span class="na">runs-on</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ubuntu-latest'</span>

      <span class="na">steps</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>

        <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-ruby@v1</span>
          <span class="na">with</span><span class="pi">:</span>
            <span class="na">ruby-version</span><span class="pi">:</span> <span class="s">${{ env.RUBY_VERSION }}</span>

        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up cache for Bundler</span>
          <span class="na">id</span><span class="pi">:</span> <span class="s">cache</span>
          <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/cache@v2</span>
          <span class="na">with</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">vendor/bundle</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">${{ runner.os }}-bundler-${{ env.RUBY_VERSION }}-${{ hashFiles('Gemfile') }}-${{ hashFiles('jekyll.gemspec') }}</span>
            <span class="na">restore-keys</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">${{ runner.os }}-bundler-${{ env.RUBY_VERSION }}-${{ hashFiles('Gemfile') }}-</span>
              <span class="pi">-</span> <span class="s">${{ runner.os }}-bundler-${{ env.RUBY_VERSION }}-</span>

        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up dependencies</span>
          <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">gem update --system --no-document</span>
            <span class="s">gem update bundler --no-document</span>
            <span class="s">bundle config set path vendor/bundle</span>
            <span class="s">bundle install --jobs 4 --retry 3</span>
            <span class="s">bundle clean</span>

        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Clone target branch</span>
          <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">REMOTE_BRANCH="${REMOTE_BRANCH:-gh-pages}"</span>
            <span class="s">REMOTE_REPO="https://${GITHUB_ACTOR}:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git"</span>
            <span class="s">echo "Publishing to ${GITHUB_REPOSITORY} on branch ${REMOTE_BRANCH}"</span>
            <span class="s">rm -rf docs/_site/</span>
            <span class="s">git clone --depth=1 --branch="${REMOTE_BRANCH}" --single-branch --no-checkout \</span>
              <span class="s">"${REMOTE_REPO}" docs/_site/</span>

        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build site</span>
          <span class="na">run</span><span class="pi">:</span> <span class="s">bundle exec jekyll build --source docs --destination docs/_site --verbose --trace</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="c1"># For jekyll-github-metadata plugin.</span>
            <span class="na">JEKYLL_GITHUB_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>

        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy to GitHub Pages</span>
          <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">SOURCE_COMMIT="$(git log -1 --pretty="%an: %B" "$GITHUB_SHA")"</span>
            <span class="s">pushd docs/_site &amp;&gt;/dev/null</span>
            <span class="s">: &gt; .nojekyll</span>
            <span class="s">git add --all</span>
            <span class="s">git -c user.name="${GITHUB_ACTOR}" -c user.email="${GITHUB_ACTOR}@users.noreply.github.com" \</span>
              <span class="s">commit --quiet \</span>
              <span class="s">--message "Deploy docs from ${GITHUB_SHA}" \</span>
              <span class="s">--message "$SOURCE_COMMIT"</span>
            <span class="s">git push</span>
            <span class="s">popd &amp;&gt;/dev/null</span>
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="notes-on-usage">Notes on usage</h2>

<p>Note these steps around Bundler and committing and publishing to GH Pages are very low-level. I wouldn‚Äôt use this across many projects myself as it would be tedious to maintain and not DRY and also I do not care about this level of control when using a single action for whole flow meets my needs. However, I might use the first few steps to manage cache, dependencies and building the site, but then rely on a more generic Action to handle committing to the <code class="language-plaintext highlighter-rouge">gh-pages</code> branch.</p>

<p>The detailed steps are preferred by the maintainers, when I brought it up on the PR. The comment was that this provides more control over logging and commit messages. At the cost of having to maintain boilerplate instead of having it maintained in a separate action (which means less control and a different kind of risk of commands going out of date or security issues). I think it also reduces dependency on actions which might not be maintained or that do things it a way that is not ideal here.</p>

<p>These steps are also intended to be used by GH and Jekyll experts and also involves a lot of boilerplate which has to be maintained. So for other projects it may make sense to use existing actions and therefore keep your workflow file shorter and simpler, and easier to maintain across many Jekyll projects. The burden of maintaining the code (for example as Bundler CLI changes) and making good choices (around Ruby, Bundler, publishing) then falls on action maintainers, which is a different kind of risk but less effort to use.</p>


        
    </div>
</article>

        </div>
    </main>
<footer class="site-footer h-card">
    <data class="u-url" href="/code-cookbook/"></data>

    <div class="wrapper">

        <h2 class="footer-heading">Code Cookbook</h2>

        <div class="footer-col-wrapper">
            <div class="footer-col footer-col-1">
                <ul class="contact-list"><li class="p-name">
                            Michael Currin
                        </li></ul>
            </div>

            <div class="footer-col footer-col-2">
<ul class="social-media-list"><li>
        <a href="https://github.com/MichaelCurrin"><svg
                class="svg-icon">
                <use xlink:href="/code-cookbook/assets/fractal-social-icons.svg#github">
                </use>
            </svg> <span class="username">MichaelCurrin</span></a>
    </li></ul>
</div>

            <div class="footer-col footer-col-3">
                <p>Reusable code patterns which you can use as reference or copy to your project</p>
            </div>
        </div>

    </div>

</footer>
<a href="https://github.com/MichaelCurrin/code-cookbook"
    class="github-corner" aria-label="View source on GitHub">
    <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
    </svg>
</a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

</body>

</html>
