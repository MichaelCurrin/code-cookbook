<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">



    <meta property="og:site_name" content="Code Cookbook" />

    <title>Commit | Code Cookbook</title>

    <meta property="og:title" content="Commit" />

    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Commit" />
<meta name="generator" content="Jekyll v4.2.1" />

<meta property="og:locale" content="en_US" />


    <meta name="description" content="How to commit and push files during the CI flow" />
    <meta property="og:description" content="How to commit and push files during the CI flow" />
<meta name="author" content="Michael Currin" />



<link rel="canonical" href="https://michaelcurrin.github.io/code-cookbook/recipes/ci-cd/github-actions/workflows/commit.html" />
<meta property="og:url" content="https://michaelcurrin.github.io/code-cookbook/recipes/ci-cd/github-actions/workflows/commit.html" />


<script type="application/ld+json">
{
    "name":        "Code Cookbook",
    "description": "How to commit and push files during the CI flow",
    "url":         "https://michaelcurrin.github.io/code-cookbook/recipes/ci-cd/github-actions/workflows/commit.html",
    "headline":    "Commit",
    "@type":       "WebSite",
    "@context":    "https://schema.org",
    "author": {
        "@type":"Person",
        "name": "Michael Currin"
    }
}
</script>
<link rel="stylesheet" href="/code-cookbook/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://michaelcurrin.github.io/code-cookbook/feed.xml" title="Code Cookbook" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-ED9PSVN5DS"></script>
    <script>
        window['ga-disable-G-ED9PSVN5DS'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
        window.dataLayer = window.dataLayer || [];

        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-ED9PSVN5DS');
    </script></head>
<body>
<header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/code-cookbook/">
            Code Cookbook
        </a><nav class="site-nav">
                <input type="checkbox" id="nav-trigger" class="nav-trigger" />

                <label for="nav-trigger">
                    <span class="menu-icon">
                        <svg viewBox="0 0 18 15" width="18px" height="15px">
                            <path
                                d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
                        </svg>
                    </span>
                </label>

                <div class="trigger"><a class="page-link" href="/code-cookbook/">
                                Home
                            </a><a class="page-link" href="/code-cookbook/recipes/">
                                Recipes
                            </a><a class="page-link" href="/code-cookbook/about.html">
                                About
                            </a></div>
            </nav></div>
</header>
<main class="page-content" aria-label="Content">
        <div class="wrapper">
            <a id="github-edit" href="https://github.com/MichaelCurrin/code-cookbook/edit/master/recipes/ci-cd/github-actions/workflows/commit.md">
    üìù <span>Edit page</span>
</a>

            <a id="github-add" href="https://github.com/MichaelCurrin/code-cookbook/new/master/recipes/ci-cd/github-actions/workflows/">
    ‚ûï <span>Add page</span>
</a>


            

<article class="post">
    <header class="post-header">
        <h1 class="post-title">
            


            <span>Commit</span>
        </h1>

        
            <blockquote>
                <p>How to commit and push files during the CI flow</p>

            </blockquote>
        
    </header>

    


    <div id="breadcrumbs">

    
        

        
            
            <a href="/code-cookbook/recipes/">
    Recipes
</a>

        
     
        
            /
        

        
            
            <a href="/code-cookbook/recipes/ci-cd/">
    CI/CD
</a>

        
     
        
            /
        

        
            
            <a href="/code-cookbook/recipes/ci-cd/github-actions/">
    GitHub Actions
</a>

        
     
        
            /
        

        
            
            <a href="/code-cookbook/recipes/ci-cd/github-actions/workflows/">
    Workflows
</a>

        
     
        
            /
        

        
            <a href="/code-cookbook/recipes/ci-cd/github-actions/workflows/commit.html" class="underline">
                Commit
            </a>
        
     
    </div>



    <br>

    <div class="post-content">
        
            <h2 id="related">Related</h2>

<ul>
  <li><a href="/code-cookbook/recipes/ci-cd/github-actions/workflows/create-pull-request.html">Create Pull Request</a> workflows - some recipes there will commit for you, so you do not need a separate commit step.</li>
</ul>

<h2 id="use-cases">Use-cases</h2>

<p>Some situations when you might want to add/edit and commit files all during a single CI run.</p>

<ul>
  <li>Binary files for distribution.
    <ul>
      <li>Compiled file for C, Go, Rust, etc.</li>
      <li>An archive file for a Ruby gem or VS Code Extension.</li>
      <li>A <code class="language-plaintext highlighter-rouge">dist</code> directory of JS files.</li>
    </ul>
  </li>
  <li>Static assets for serving on GH Pages.
    <ul>
      <li>Build with a static site generator like Jekyll, Hugo or Gatsby.</li>
      <li>Build your Node app with <code class="language-plaintext highlighter-rouge">npm run build</code>.</li>
    </ul>
  </li>
  <li>Doc changes in <code class="language-plaintext highlighter-rouge">README.md</code>.
    <ul>
      <li>Update a list of contributors. (A GH bot can handle this for you)</li>
      <li>Update a table of contents.</li>
    </ul>
  </li>
  <li>Code changes.
    <ul>
      <li>Perform lint fixes.</li>
      <li>Perform package upgrades.</li>
    </ul>
  </li>
</ul>

<h2 id="samples">Samples</h2>

<p>A placeholder step is used to modify files in the workspace. Replace it with something more suitable. Such as building your app or applying lint and formatting fixes.</p>

<h3 id="no-action">No action</h3>

<p>A simple way to commit any changes on the current branch and push changes.</p>

<p>This is slightly verbose but not too long. You know exactly what it is doing and it is easy to customize.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">main.yml</code>
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout</span>
      <span class="c1"># uses: ...</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build</span>
      <span class="c1"># run: ...</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Check for modified files</span>
      <span class="na">id</span><span class="pi">:</span> <span class="s">git-check</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">echo ::set-output name=modified::$(if git diff-index --quiet HEAD --; then echo "false"; else echo "true"; fi)</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Commit and push changes</span>
      <span class="na">if</span><span class="pi">:</span> <span class="s">steps.git-check.outputs.modified == 'true'</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">git config --global user.name 'Automated Publisher'</span>
        <span class="s">git config --global user.email 'actions@users.noreply.github.com'</span>
        <span class="s">git commit -am "Commit message..."</span>

        <span class="s">git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"</span>
        <span class="s">git push</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>You can also commit in two steps:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git add <span class="nt">-A</span>
git commit <span class="nt">-m</span> <span class="s2">"Add untracked file during workflow"</span>
</code></pre></div></div>

<p>The commit step will commit <em>all</em> file changes - both modified files and previously untracked files that got created for the first time.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    -a, --all             commit all changed files
</code></pre></div></div>

<p>This uses a branch that already exists (whether a feature branch or <code class="language-plaintext highlighter-rouge">master</code>), so you don‚Äôt need give extra options to <code class="language-plaintext highlighter-rouge">git push</code>.</p>

<h3 id="use-the-publish-to-github-action">Use the Publish to GitHub action</h3>

<p>Use this action to commit and push your changes to either the current branch or a given branch. If on another branch, you‚Äôll need an action to make a <a href="/code-cookbook/recipes/ci-cd/github-actions/workflows/create-pull-request.html">Pull Request</a>.</p>

<p>See <a href="https://github.com/marketplace/actions/push-new-files-back-to-master">push-new-files-back-to-master</a> Action in the GH Marketplace.</p>

<blockquote>
  <p>A GitHub Action to push any local file changes, including new files, back to supplied branch name.</p>

  <p>This action is useful to put after other actions that modify files in the local checkout that you‚Äôd then like to persist back into the repository.</p>
</blockquote>

<ul>
  <li><code class="language-plaintext highlighter-rouge">main.yml</code>
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout</span>
      <span class="c1"># uses: ...</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build</span>
      <span class="c1"># run: ...</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Commit changes</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">mikeal/publish-to-github-action@master</span>
      <span class="na">env</span><span class="pi">:</span>
        <span class="na">GITHUB_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>Currently there‚Äôs only a <code class="language-plaintext highlighter-rouge">1.0.0</code> tag of the Action - I don‚Äôt know if <code class="language-plaintext highlighter-rouge">@v1</code> will work here. But it is worth locking rather than the floating <code class="language-plaintext highlighter-rouge">@master</code>.</p>

<p>Specify another branch of yours, instead of the <code class="language-plaintext highlighter-rouge">master</code> default.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">BRANCH_NAME</span><span class="pi">:</span> <span class="s">main</span>
</code></pre></div></div>

<p>If you look at the code in the action, this is what is does (excluding validating variables and working with GitHub LFS).</p>

<p>I‚Äôve refactored it and added below:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">entrypoint.sh</code>
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># Initialize git.</span>
  <span class="nv">REMOTE_REPO</span><span class="o">=</span><span class="s2">"https://</span><span class="k">${</span><span class="nv">GITHUB_ACTOR</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">GITHUB_TOKEN</span><span class="k">}</span><span class="s2">@github.com/</span><span class="k">${</span><span class="nv">GITHUB_REPOSITORY</span><span class="k">}</span><span class="s2">.git"</span>

  git config http.sslVerify <span class="nb">false
  </span>git config user.name <span class="s2">"Automated Publisher"</span>
  git config user.email <span class="s2">"actions@users.noreply.github.com"</span>
  git remote add publisher <span class="s2">"</span><span class="k">${</span><span class="nv">REMOTE_REPO</span><span class="k">}</span><span class="s2">"</span>
  git show-ref  <span class="c"># Useful for debugging</span>
  git branch <span class="nt">--verbose</span>

  <span class="c"># Publish any new files.</span>
  git checkout <span class="k">${</span><span class="nv">BRANCH_NAME</span><span class="k">}</span>
  git add <span class="nt">-A</span>
  <span class="nv">TIMESTAMP</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> <span class="nt">-u</span><span class="si">)</span>
  git commit <span class="nt">-m</span> <span class="s2">"Automated publish: </span><span class="k">${</span><span class="nv">TIMESTAMP</span><span class="k">}</span><span class="s2"> </span><span class="k">${</span><span class="nv">GITHUB_SHA</span><span class="k">}</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">exit </span>0
  git pull <span class="nt">--rebase</span> publisher <span class="k">${</span><span class="nv">BRANCH_NAME</span><span class="k">}</span>
  git push publisher <span class="k">${</span><span class="nv">BRANCH_NAME</span><span class="k">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="notes-on-the-shell-script">Notes on the shell script</h4>

<p>This action works on the root and doesn‚Äôt let you target a build directory like <code class="language-plaintext highlighter-rouge">_site</code>. So this is not a good idea for GH Pages. Even if you switch from <code class="language-plaintext highlighter-rouge">master</code> to <code class="language-plaintext highlighter-rouge">gh-pages</code> and your <code class="language-plaintext highlighter-rouge">.md</code> files are gone, your unversioned files (cache and gems) won‚Äôt be ignored properly and would be committed unnecessarily.</p>

<p>It looks like the clone is built into the standard workflow itself, so this doesn‚Äôt have a clone step.</p>

<p>The rebase might not do be useful if you are already up to date, unless there is something that gets committed between the start of the run and that pull step. Maybe the pull should be done before the commit? Note that you can‚Äôt do a pull with a rebase unless you stage changes first.</p>

<p>This will only work if the branch already exists, as it does not use <code class="language-plaintext highlighter-rouge">-b</code> in checkout.</p>

<p>For comparison, there is a similar action dedicated to GitHub Pages, but it uses TypeScript and has a lot more files.</p>

<ul>
  <li><a href="https://github.com/peaceiris/actions-gh-pages">peaceiris/actions-gh-pages</a></li>
</ul>

<h2 id="use-the-add-and-commit-action">Use the Add and Commit action</h2>

<ul>
  <li><a href="https://github.com/EndBug/add-and-commit">Add and commit</a></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">steps</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">EndBug/add-and-commit@v7</span>
   <span class="na">with</span><span class="pi">:</span>
     <span class="na">default_author</span><span class="pi">:</span> <span class="s">github_actions</span>
</code></pre></div></div>


        
    </div>
</article>

        </div>
    </main>
<footer class="site-footer h-card">
    <data class="u-url" href="/code-cookbook/"></data>

    <div class="wrapper">

        <h2 class="footer-heading">Code Cookbook</h2>

        <div class="footer-col-wrapper">
            <div class="footer-col footer-col-1">
                <ul class="contact-list"><li class="p-name">
                            Michael Currin
                        </li></ul>
            </div>

            <div class="footer-col footer-col-2">
<ul class="social-media-list"><li>
            <a href="https://github.com/MichaelCurrin"><svg class="svg-icon">
                    <use xlink:href="/code-cookbook/assets/fractal-social-icons.svg#github"></use>
                </svg> <span class="username">MichaelCurrin</span></a>
        </li></ul>
</div>

            <div class="footer-col footer-col-3">
                <p>Reusable code patterns which you can use as reference or copy to your project</p>
            </div>
        </div>

    </div>

</footer>
<a href="https://github.com/MichaelCurrin/code-cookbook"
    class="github-corner" aria-label="View source on GitHub">
    <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
    </svg>
</a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

</body>

</html>
